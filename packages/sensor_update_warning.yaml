##############################################################
### Packages / Sensor Update Warning                       ###
### @cvoid - https://github.com/bl0rp/Home-AssistantConfig ###
##############################################################

homeassistant:
  customize:
    sensor.phonebatt_watch:
      friendly_name: Handyakku Pixel4XL
    sensor.esp32_01_watch:
      friendly_name: TÃ¼rsensor ELW
    sensor.esp32_02_watch:
      friendly_name: Haupteingang
    sensor.esp32_03_watch:
      friendly_name: Carport
    sensor.esp32_08_watch:
      friendly_name: Katzenklappe


##### notify component -> logfile
notify:
    - name: sensor_watch_log
      platform: file
      filename: /home/homeassistant/log/sensor_update.txt

sensor:

###### warning if battery powered sensor does not update
#battery mobile 2hours
  - platform: template
    sensors:
      phonebatt_watch:
        entity_id: sensor.time
        value_template: "{% if as_timestamp(states.sensor.date_time.last_updated) - as_timestamp(states.sensor.tasker_pixel4xl_battery.last_updated) > 120*60 %}true{% else %}false{% endif %}"
#door_sensor_elw 7hours
      esp32_01_watch:
        entity_id: sensor.time
        value_template: "{% if as_timestamp(states.sensor.date_time.last_updated) - as_timestamp(states.sensor.esp32_01_rssi.last_updated) > 420*60 %}true{% else %}false{% endif %}"
#outdoor sensor 2 2hours
      esp32_02_watch:
        entity_id: sensor.time
        value_template: "{% if as_timestamp(states.sensor.date_time.last_updated) - as_timestamp(states.sensor.esp32_02_temperature.last_updated) > 120*60 %}true{% else %}false{% endif %}"
#outdoor sensor 3 2hours
      esp32_03_watch:
        entity_id: sensor.time
        value_template: "{% if as_timestamp(states.sensor.date_time.last_updated) - as_timestamp(states.sensor.esp32_03_temperature.last_updated) > 120*60 %}true{% else %}false{% endif %}"

#catflap sensor 8 7hours
      esp32_08_watch:
        entity_id: sensor.time
        value_template: "{% if as_timestamp(states.sensor.date_time.last_updated) - as_timestamp(states.sensor.esp32_08_rssi.last_updated) > 420*60 %}true{% else %}false{% endif %}"



#################################################
### Notify when a Sensor does not update      ###
#################################################
automation:
  - alias: notify_sensor_update
    initial_state: 'on'
    trigger:
      - platform: state
        entity_id:
          - sensor.phonebatt_watch
          - sensor.esp32_01_watch
          - sensor.esp32_02_watch
          - sensor.esp32_03_watch
          - sensor.esp32_08_watch
        to: 'true'
    condition:
      condition: and
      conditions:
        - condition: template
          value_template: "{% if trigger.from_state and trigger.to_state %} True {% else %} False {% endif %}"
    action:
    - service: notify.telegram_christoph
      data_template:
        message: >
          NO UPDATE: {{ now().strftime('%d.%m.%Y %H:%M:%S') }} Sensor {{ trigger.to_state.attributes.friendly_name }}
    - service: notify.sensor_watch_log
      data_template:
        message: >
          NO UPDATE: {{ now().strftime('%d.%m.%Y %H:%M:%S') }} Sensor {{ trigger.to_state.attributes.friendly_name }}
