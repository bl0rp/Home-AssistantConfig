##############################################################
### Packages / Sensor Update Warning                       ###
### @cvoid - https://github.com/bl0rp/Home-AssistantConfig ###
##############################################################

homeassistant:
  customize:
    sensor.phonebatt_watch:
      friendly_name: Handyakku
###### STATE CARD for views.yaml

group:
  sensor_warn:
    control: hidden
    icon: mdi:ethernet-cable
    name: Sensorwarn
    entities:
    - sensor.phonebatt
    - sensor.phonebatt_debug
    - sensor.phonebatt_debug2
    - sensor.phonebatt_watch
    - automation.notify_sensor_update
sensor:

###### warning if battery powered sensor does not update
  - platform: template
    sensors:
      phonebatt_watch:
        value_template: "{% if as_timestamp(states.sensor.date__time.last_updated) - as_timestamp(states.sensor.phonebatt.last_updated) > 1*60 %}true{% else %}false{% endif %}"
      phonebatt_debug:
        value_template: "{{ as_timestamp(states.sensor.date__time.last_updated) - as_timestamp(states.sensor.phonebatt.last_updated)  }}"
      phonebatt_debug2:
        value_template: "{{ states.sensor.phonebatt.last_updated  }}"

#################################################
### Notify when a Sensor does not update      ###
#################################################
automation:
  - alias: notify_sensor_update
    initial_state: 'on'
    trigger:
      - platform: state
        entity_id:
          - sensor.phonebatt_watch
        to: 'true'
    condition:
      condition: and
      conditions:
        - condition: template
          value_template: "{% if trigger.from_state and trigger.to_state %} True {% else %} False {% endif %}"
    action:
    - service: notify.pushbullet
      data_template:
        message: >
          NO UPDATE: Sensor {{ trigger.to_state.attributes.friendly_name }}
