##############################################################
### Packages / Sensor Update Warning                       ###
### @cvoid - https://github.com/bl0rp/Home-AssistantConfig ###
##############################################################

homeassistant:
  customize:
    sensor.phonebatt_watch:
      friendly_name: Handyakku Pixel3XL
    sensor.esp32_02_watch:
      friendly_name: Haupteingang
    sensor.esp32_03_watch:
      friendly_name: Carport
###### STATE CARD for views.yaml

group:
  sensor_warn:
    control: hidden
    icon: mdi:ethernet-cable
    name: Sensorwarn
    entities:
    - sensor.phonebatt_pixel3xl
    - sensor.phonebatt_debug
    - sensor.phonebatt_debug2
    - sensor.phonebatt_watch
    - sensor.esp32_02_temperature
    - sensor.esp32_02_debug
    - sensor.esp32_02_debug2
    - sensor.esp32_02_watch
    - sensor.esp32_03_temperature
    - sensor.esp32_03_debug
    - sensor.esp32_03_debug2
    - sensor.esp32_03_watch
    - automation.notify_sensor_update

##### notify component -> logfile



notify:
    - name: sensor_watch_log
      platform: file
      filename: /home/homeassistant/log/sensor_update.txt

sensor:

###### warning if battery powered sensor does not update
#battery mobile
  - platform: template
    sensors:
      phonebatt_watch:
        entity_id: sun.sun
        value_template: "{% if as_timestamp(states.sensor.date_time.last_updated) - as_timestamp(states.sensor.phonebatt_pixel3xl.last_updated) > 120*60 %}true{% else %}false{% endif %}"
      phonebatt_debug:
        entity_id: sun.sun
        value_template: "{{ as_timestamp(states.sensor.date_time.last_updated) - as_timestamp(states.sensor.phonebatt_pixel3xl.last_updated)  }}"
      phonebatt_debug2:
        entity_id: sun.sun
        value_template: "{{ states.sensor.phonebatt_pixel3xl.last_updated  }}"
#outdoor sensor 2
      esp32_02_watch:
        entity_id: sun.sun
        value_template: "{% if as_timestamp(states.sensor.date_time.last_updated) - as_timestamp(states.sensor.esp32_02_temperature.last_updated) > 120*60 %}true{% else %}false{% endif %}"
      esp32_02_debug:
        entity_id: sun.sun
        value_template: "{{ as_timestamp(states.sensor.date_time.last_updated) - as_timestamp(states.sensor.esp32_02_temperature.last_updated)  }}"
      esp32_02_debug2:
        entity_id: sun.sun
        value_template: "{{ states.sensor.esp32_02_temperature.last_updated  }}"
#outdoor sensor 3
      esp32_03_watch:
        entity_id: sun.sun
        value_template: "{% if as_timestamp(states.sensor.date_time.last_updated) - as_timestamp(states.sensor.esp32_03_temperature.last_updated) > 120*60 %}true{% else %}false{% endif %}"
      esp32_03_debug:
        entity_id: sun.sun
        value_template: "{{ as_timestamp(states.sensor.date_time.last_updated) - as_timestamp(states.sensor.esp32_03_temperature.last_updated)  }}"
      esp32_03_debug2:
        entity_id: sun.sun
        value_template: "{{ states.sensor.esp32_03_temperature.last_updated  }}"
#################################################
### Notify when a Sensor does not update      ###
#################################################
automation:
  - alias: notify_sensor_update
    initial_state: 'on'
    trigger:
      - platform: state
        entity_id:
          - sensor.phonebatt_watch
          - sensor.esp32_02_watch
          - sensor.esp32_03_watch
        to: 'true'
    condition:
      condition: and
      conditions:
        - condition: template
          value_template: "{% if trigger.from_state and trigger.to_state %} True {% else %} False {% endif %}"
    action:
    - service: notify.pushbullet
      data_template:
        message: >
          NO UPDATE: {{ now().strftime('%d.%m.%Y %H:%M:%S') }} Sensor {{ trigger.to_state.attributes.friendly_name }}
    - service: notify.sensor_watch_log
      data_template:
        message: >
          NO UPDATE: {{ now().strftime('%d.%m.%Y %H:%M:%S') }} Sensor {{ trigger.to_state.attributes.friendly_name }}
